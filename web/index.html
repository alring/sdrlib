<!DOCTYPE html>
<html>
<head>


<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>

<script>


function Waterfall(par, anchor, width, height)
{
    function trace(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    function error(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    var self = this;

    var canvas = $("<canvas>").width(width).height(height);
    anchor.append(canvas);
    var ctx = canvas.get(0).getContext("2d");
    
    
    function update(data) {
        
    }    
    this.update = update();
}


function SdrClient(anchorName)
{
    
    function trace(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    function error(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    var self = this;
    

    var anchor = $(anchorName);
    var sdrBox = $("<div>");
    anchor.append(sdrBox);
    
    var wfAnchor = $("<div>");
    sdrBox.append(wfAnchor);
    
    var wf = new Waterfall(this, wfAnchor, 600, 200);

    var startBtn = $("<button>").html("Start");
    startBtn.click(function() {
        send("start");
    });
    
    var exportBtn = $("<button>").html("Export");
    sdrBox.append(startBtn, exportBtn);


    var context = new AudioContext();
    var source = context.createBufferSource();

    
    


    function play(data) {
        
        function success(buffer) {
            source.buffer = buffer;
    	    source.connect(context.destination);
        	source.start(0); 
        }
        
        function failure(msg) {
            error(msg);
        }
        
        context.decodeAudioData(data, success, failure);
    }


    function onOpen(evt) {
        trace("open:" + evt.reason);
    }

    function onClose(evt) {
        trace("close: " + evt.reason);
    }
    
    function onMessage(evt) {
        trace("rcv:" + evt.data.byteLength);
        play(evt.data);
    }

    function onError(evt) {
        trace("onerror:" + evt.reason);
    }


    var uri = "ws://localhost:8080/sdr";
    var sock = new WebSocket(uri);
    sock.binaryType = "arraybuffer";
    sock.onopen     = onOpen;
    sock.onclose    = onClose;
    sock.onmessage  = onMessage;
    sock.onerror    = onError;


    function send(dat) {
        sock.send(dat);
    }

}








$(document).ready(function() {
    new SdrClient("#sdr");    

});


</script>



</head>
<body>



<div id="sdr"></div>





</body>
</html>

