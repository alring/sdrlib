<!DOCTYPE html>
<html>
<head>


<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>

<script>


function Waterfall(par, anchor, initialWidth, initialHeight)
{
    function trace(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    function error(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    var self = this;
    
    var width = initialWidth;
    var height = initialHeight;

    var canvas = $("<canvas>").width(width).height(height);
    anchor.append(canvas);
    var ctx = canvas.get(0).getContext("2d");
    var imageData = ctx.createImageData(width, height);
    var buf = new ArrayBuffer(imageData.data.length);
    var data8  = new Uint8ClampedArray(buf);
    var data32 = new Uint32Array(buf);
    
    canvas.resize(function() {
        width  = canvas.width();
        height = canvas.height();
        imageData = ctx.createImageData(width, height);
        buf = new ArrayBuffer(imageData.data.length);
        data8  = new Uint8ClampedArray(buf);
        data32 = new Uint32Array(buf);
    });
    
    
    var clut = [
        0x4000ffff, 0x3b00ffff, 0x3700ffff, 0x3300ffff, 0x2e00ffff, 0x2a00ffff, 0x2600ffff, 0x2200ffff,
        0x1d00ffff, 0x1900ffff, 0x1500ffff, 0x1100ffff, 0x0c00ffff, 0x0800ffff, 0x0400ffff, 0x0000ffff,
        0x0004ffff, 0x0008ffff, 0x000cffff, 0x0011ffff, 0x0015ffff, 0x0019ffff, 0x001dffff, 0x0022ffff,
        0x0026ffff, 0x002affff, 0x002effff, 0x0033ffff, 0x0037ffff, 0x003bffff, 0x0040ffff, 0x0044ffff,
        0x0048ffff, 0x004cffff, 0x0051ffff, 0x0055ffff, 0x0059ffff, 0x005dffff, 0x0062ffff, 0x0066ffff,
        0x006affff, 0x006effff, 0x0073ffff, 0x0077ffff, 0x007bffff, 0x0080ffff, 0x0084ffff, 0x0088ffff,
        0x008cffff, 0x0091ffff, 0x0095ffff, 0x0099ffff, 0x009dffff, 0x00a2ffff, 0x00a6ffff, 0x00aaffff,
        0x00aeffff, 0x00b3ffff, 0x00b7ffff, 0x00bbffff, 0x00bfffff, 0x00c4ffff, 0x00c8ffff, 0x00ccffff,
        0x00d1ffff, 0x00d5ffff, 0x00d9ffff, 0x00ddffff, 0x00e2ffff, 0x00e6ffff, 0x00eaffff, 0x00eeffff,
        0x00f3ffff, 0x00f7ffff, 0x00fbffff, 0x00ffffff, 0x00fffbff, 0x00fff7ff, 0x00fff3ff, 0x00ffeeff,
        0x00ffeaff, 0x00ffe6ff, 0x00ffe2ff, 0x00ffddff, 0x00ffd9ff, 0x00ffd5ff, 0x00ffd1ff, 0x00ffccff,
        0x00ffc8ff, 0x00ffc4ff, 0x00ffbfff, 0x00ffbbff, 0x00ffb7ff, 0x00ffb3ff, 0x00ffaeff, 0x00ffaaff,
        0x00ffa6ff, 0x00ffa2ff, 0x00ff9dff, 0x00ff99ff, 0x00ff95ff, 0x00ff91ff, 0x00ff8cff, 0x00ff88ff,
        0x00ff84ff, 0x00ff80ff, 0x00ff7bff, 0x00ff77ff, 0x00ff73ff, 0x00ff6eff, 0x00ff6aff, 0x00ff66ff,
        0x00ff62ff, 0x00ff5dff, 0x00ff59ff, 0x00ff55ff, 0x00ff51ff, 0x00ff4cff, 0x00ff48ff, 0x00ff44ff,
        0x00ff40ff, 0x00ff3bff, 0x00ff37ff, 0x00ff33ff, 0x00ff2eff, 0x00ff2aff, 0x00ff26ff, 0x00ff22ff,
        0x00ff1dff, 0x00ff19ff, 0x00ff15ff, 0x00ff11ff, 0x00ff0cff, 0x00ff08ff, 0x00ff04ff, 0x00ff00ff,
        0x04ff00ff, 0x08ff00ff, 0x0cff00ff, 0x11ff00ff, 0x15ff00ff, 0x19ff00ff, 0x1dff00ff, 0x22ff00ff,
        0x26ff00ff, 0x2aff00ff, 0x2eff00ff, 0x33ff00ff, 0x37ff00ff, 0x3bff00ff, 0x40ff00ff, 0x44ff00ff,
        0x48ff00ff, 0x4cff00ff, 0x51ff00ff, 0x55ff00ff, 0x59ff00ff, 0x5dff00ff, 0x62ff00ff, 0x66ff00ff,
        0x6aff00ff, 0x6eff00ff, 0x73ff00ff, 0x77ff00ff, 0x7bff00ff, 0x80ff00ff, 0x84ff00ff, 0x88ff00ff,
        0x8cff00ff, 0x91ff00ff, 0x95ff00ff, 0x99ff00ff, 0x9dff00ff, 0xa2ff00ff, 0xa6ff00ff, 0xaaff00ff,
        0xaeff00ff, 0xb3ff00ff, 0xb7ff00ff, 0xbbff00ff, 0xbfff00ff, 0xc4ff00ff, 0xc8ff00ff, 0xccff00ff,
        0xd1ff00ff, 0xd5ff00ff, 0xd9ff00ff, 0xddff00ff, 0xe2ff00ff, 0xe6ff00ff, 0xeaff00ff, 0xeeff00ff,
        0xf3ff00ff, 0xf7ff00ff, 0xfbff00ff, 0xffff00ff, 0xfffb00ff, 0xfff700ff, 0xfff300ff, 0xffee00ff,
        0xffea00ff, 0xffe600ff, 0xffe200ff, 0xffdd00ff, 0xffd900ff, 0xffd500ff, 0xffd100ff, 0xffcc00ff,
        0xffc800ff, 0xffc400ff, 0xffbf00ff, 0xffbb00ff, 0xffb700ff, 0xffb300ff, 0xffae00ff, 0xffaa00ff,
        0xffa600ff, 0xffa200ff, 0xff9d00ff, 0xff9900ff, 0xff9500ff, 0xff9100ff, 0xff8c00ff, 0xff8800ff,
        0xff8400ff, 0xff8000ff, 0xff7b00ff, 0xff7700ff, 0xff7300ff, 0xff6e00ff, 0xff6a00ff, 0xff6600ff,
        0xff6200ff, 0xff5d00ff, 0xff5900ff, 0xff5500ff, 0xff5100ff, 0xff4c00ff, 0xff4800ff, 0xff4400ff,
        0xff4000ff, 0xff3b00ff, 0xff3700ff, 0xff3300ff, 0xff2e00ff, 0xff2a00ff, 0xff2600ff, 0xff2200ff,
        0xff1d00ff, 0xff1900ff, 0xff1500ff, 0xff1100ff, 0xff0c00ff, 0xff0800ff, 0xff0400ff, 0xff0000ff
    ];

    
    /**
     * Data will be an ArrayBuffer of 256-bit bytes
     */
    function update(buffer) {
        //trace("update:" + width + ":" + height);
        var datalen = buffer.byteLength;
        var byteArr = new Uint8ClampedArray(buffer);
        var nrPixels = data32.length;
        var lastRow = nrPixels - width;  //get last row 
        for (var i = 0 ; i < lastRow ; i++) {
            data32[i] = data32[i+width];
        }
        var acc = -datalen;
        var col = lastRow;
        for (var i = 0; i < datalen ; i++) {
            acc += width;
            if (acc >= 0) {
                acc -= datalen;
                var pix = clut[byteArr[i]]
                data32[col++] = pix;
            }
        }

        imageData.data.set(data8);
        ctx.putImageData(imageData, 0, 0);    
    }    
    this.update = update;
}


function SdrClient(anchorName)
{
    
    function trace(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    function error(msg) {
        if (typeof(console) !== "undefined")
            console.log("Sdr: " + msg);
    }

    var self = this;
    

    var anchor = $(anchorName);
    var sdrBox = $("<div>");
    anchor.append(sdrBox);
    
    var wfAnchor = $("<div>");
    sdrBox.append(wfAnchor);
    
    var wf = new Waterfall(this, wfAnchor, 600, 200);

    var startBtn = $("<button>").html("Start");
    startBtn.click(function() {
        send("start");
    });
    
    var exportBtn = $("<button>").html("Export");
    sdrBox.append(startBtn, exportBtn);


    var context = new AudioContext();
    var source = context.createBufferSource();

    
    


    function play(data) {
        
        function success(buffer) {
            source.buffer = buffer;
    	    source.connect(context.destination);
        	source.start(0); 
        }
        
        function failure(msg) {
            error(msg);
        }
        
        context.decodeAudioData(data, success, failure);
    }


    function onOpen(evt) {
        trace("open:" + evt.reason);
    }

    function onClose(evt) {
        trace("close: " + evt.reason);
    }
    
    function onMessage(evt) {
        trace("rcv:" + evt.data.byteLength);
        play(evt.data);
    }

    function onError(evt) {
        trace("onerror:" + evt.reason);
    }


    /*
    var uri = "ws://localhost:8080/sdr";
    var sock = new WebSocket(uri);
    sock.binaryType = "arraybuffer";
    sock.onopen     = onOpen;
    sock.onclose    = onClose;
    sock.onmessage  = onMessage;
    sock.onerror    = onError;
    */

    function send(dat) {
        sock.send(dat);
    }
    
    this.testme = function() {
        
        function test() {
            var len = 1024;
            var buf = new ArrayBuffer(len);
            var arr = new Uint8ClampedArray(buf);
            for (var i = 0 ; i < len ; i++) {
                arr[i] = Math.floor((Math.random() * 192.0));
            }
        wf.update(buf);
        }
        
        setInterval(test, 50);
    };

}








$(document).ready(function() {
    var cli = new SdrClient("#sdr");
    cli.testme();    

});


</script>



</head>
<body>



<div id="sdr"></div>





</body>
</html>

